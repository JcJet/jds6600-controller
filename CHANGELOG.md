# Changelog / Release notes

## v1.0.4 (2026-02-09)

### Новое

#### `cycle`: диапазоны и adaptive-voltage
- Внутри списка частот `cycle` можно использовать **диапазоны** (объекты вида `{"start":...,"end":...,"step":...}`), которые перебираются **лениво** (без разворачивания в огромный массив в памяти).
- Добавлен параметр `adaptive-voltage=<true|false>`: при `true` вместе с частотой автоматически подбирается **amplitude** по той же кривой, что и в `mod`.
  - При `adaptive-voltage=true` параметр `"amplitude"` из JSON‑настроек игнорируется.


Пример обновлённого `cycle` (диапазон + авто‑напряжение, без паузы между частотами):
```csv
cycle,[30000,44000,{"start":55000,"end":200000,"step":0.1},1000000],on=0.5,off=0,adaptive-voltage=true,{"channel":"1","waveform":"sine"}
```


#### GUI: улучшенная проверка CSV
Диалог **«Проверить CSV»** теперь (best‑effort) показывает проблемную **строку** и, для ошибок `cycle`, конкретный **элемент списка**, который сломался.

#### Первый запуск: канал по умолчанию
Если ещё нет сохранённых настроек, значение **«Канал (по умолчанию)»** устанавливается в **1**.

### Изменения

#### Повтор файла
Галочка **«Повтор файла»** теперь повторяет то, что сейчас находится в редакторе (поведение эквивалентно повторному нажатию «Старт»), поэтому работает и для несохранённого файла.

## v1.0.3 (2026-02-07)

### Новое

#### `mod` — модуляция / перебор частот (FM sweep)
Команда для плавного изменения частоты в диапазоне `start..end` с равномерной скоростью.

Формат:
```csv
mod[,start=<Hz>][,end=<Hz>][,time=<sec>][,update=<ms>][,direction=<rise|fall|rise-and-fall>][,adaptive-voltage=<true|false>][,repeat=<true|false>][,<опциональные настройки JSON>]
```

Параметры:
- `start` — начальная частота (Hz), **минимум 0**
- `end` — конечная частота (Hz), **минимум 0**
- `time` — время одного прохода (`start→end` или `end→start`) **в секундах**
- `update` — частота обновления **в миллисекундах** (как часто отправлять новую частоту, и напряжение при необходимости)
- `direction`:
  - `rise` — от `start` к `end`, затем (если `repeat=true`) возврат к `start`
  - `fall` — от `end` к `start`, затем (если `repeat=true`) возврат к `end`
  - `rise-and-fall` — непрерывно вперёд‑назад (start→end→start)
- `adaptive-voltage` — если `true`, вместе с частотой подбирается **amplitude** по кривой `clamp(C*f^k, 5..20)`
- `repeat` — если `false`, команда завершится после одного цикла/прохода

Значения по умолчанию:
- `start=1`, `end=1000000`, `time=1`, `update=50`, `direction=rise-and-fall`, `adaptive-voltage=false`, `repeat=true`

Пример:
```csv
mod,start=1,end=10000,time=2,update=20,direction=rise-and-fall,adaptive-voltage=true,repeat=true,{"channel":"1","waveform":"sine"}
```

⚠️ При запуске `mod` в режиме **двух каналов (1+2)** в лог выводится предупреждение о возможной нестабильности. Рекомендуется использовать один канал (`{"channel":"1"}`) или включить синхронизацию каналов в настройках генератора.

#### Продолжение после закрытия (auto‑resume)
GUI запоминает текущую позицию выполнения и позволяет продолжить после перезапуска приложения:
- сохраняется позиция **строки/шага**
- для `wait` сохраняется **остаток времени**
- для `mod` сохраняется позиция **внутри sweep** (leg/k)
- для `cycle` сохраняется позиция автоматически, т.к. цикл разворачивается в шаги

Важно:
- auto‑resume работает **только для сохранённого файла** (проверяется sha256)
- если файл был изменён и при выходе выбрано **«Нет»** на вопрос о сохранении — позиция **не сохраняется**

#### Строка состояния устройства (polling)
Внизу окна отображается состояние генератора по каналам (on/off, wave, freq, amplitude, offset, duty), опрос ~1 раз в секунду.
Во время `mod` статус показывает **«Режим FM модуляции»**.

#### Повтор файла
Добавлена галочка **«Повтор файла»** (под блоком «Фиксированный wait»):
- после окончания сценария файл автоматически стартует заново
- повтор выполняется для **сохранённого/не изменённого** файла, чтобы избежать запуска “временного” содержимого

### Изменения интерфейса
- Убрана колонка **номеров строк** в редакторе (при переносах строк номера вводили в заблуждение).
- Разные мелкие улучшения/устойчивость логирования и статуса.

