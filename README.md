# JDS6600 Controller (GUI + CLI)

Утилита для управления DDS‑генератором **JDS6600** по USB/Serial, на базе библиотеки `jds6600`.

- **GUI (Tkinter)**: открыть/редактировать файл команд, автопоиск устройства, запуск/пауза/стоп, пропуск ожидания, подсветка текущей строки., проверка CSV (показывает проблемную строку и элемент для cycle).
- **Строка статуса устройства** (внизу): раз в секунду читает состояние генератора по каждому каналу (on/off, wave, freq, amplitude, offset, duty). Если нет подключения — показывает «Нет подключения».
- **Продолжение после закрытия (auto‑resume)**: если выполнение было запущено и файл команд сохранён, при следующем запуске можно продолжить с того же места (включая `wait`, `cycle`, `mod`).
- **Повтор файла**: галочка «Повтор файла» — после окончания сценария он стартует заново (повторяется то, что сейчас в редакторе, как при повторном нажатии «Старт»).
- **Предупреждение для `mod` в режиме «1+2»**: если модуляция запущена на два канала, в лог выводится предупреждение о возможной нестабильности и рекомендация использовать один канал или синхронизацию в настройках генератора.
- **Подключиться/Отключиться**: кнопка рядом с автопоиском. Автопоиск сразу подключается.
- **CLI**: удобно для автоматизации/скриптов.
- **Windows**: собирается в portable **.exe** (без установки Python у пользователя).
- **Linux (Ubuntu)**: работает как обычный python‑скрипт, можно собирать AppImage.

---

## Быстрый старт (для пользователей)

### Windows (portable .exe)
1. Скачайте `JDS6600Controller.exe`.
2. Подключите генератор по USB.
3. Запустите `.exe`.
4. Нажмите **Авто‑поиск** (или выберите порт вручную) — в статусе должно стать **«устройство найдено»**.
5. Нажмите **Старт**.

Если устройство не находится:
- подождите 5–10 секунд после подключения (Windows ставит драйвер),
- переподключите USB,
- перезагрузите ПК,
- при необходимости установите драйвер CH340/CH341 (часто идёт на диске/сайте устройства).

### Ubuntu / Linux (из исходников)
Требуется `python3-tk` (GUI) и права на сериал‑порт.

```bash
sudo apt update
sudo apt install -y python3-tk
python3 run_gui.py
```

> Если видите “Permission denied” на `/dev/ttyUSB0` — добавьте пользователя в группу `dialout`:
> `sudo usermod -aG dialout $USER` и перелогиньтесь.

---

## GUI: элементы управления

- **Фиксированный wait (сек)** — если включить, то любая команда `wait,<x>` выполняется как `wait,<фиксированное значение>`.
- **Повтор файла** — если включить, то после конца сценария он стартует заново (повторяется текущий текст в редакторе).
- **СТАРТ** — запуск сценария с начала (используется текущий текст в редакторе).
- **Пауза/Продолжить** — пауза и продолжение сценария. Если для сохранённого файла есть сохранённая позиция выполнения, то при запуске программы сценарий автоматически открывается в режиме паузы (как будто нажали **СТАРТ** и сразу **Пауза**): активны **Продолжить**, **Следующая команда**, **Стоп**, подсвечена текущая строка.
- **Следующая команда** — пропускает текущий `wait`.


---

## Установка для разработки (Python)

```bash
python -m venv .venv
# Linux
source .venv/bin/activate
# Windows (PowerShell)
# .\.venv\Scripts\Activate.ps1

pip install -r requirements.txt
```

---

## Формат файла команд (CSV)

Файл — обычный текстовый `.csv`. Строки‑команды:

### 1) `freq`
```
freq,<Hz>[,<опциональные настройки>]
```

Пример:
```csv
freq,1000,{"channel":"1+2","waveform":"sine","amplitude":1.0}
```

### 2) `wait`
```
wait,<секунды>
```

Пример:
```csv
wait,2.5
```

### 3) `stop`
```
stop
```
Выключает оба канала (outputs off). **Команда поддерживается**, но в шаблонных файлах по умолчанию не вставляется.



### 4) `mod` (модуляция / перебор частот)
```
mod[,start=<Hz>][,end=<Hz>][,time=<sec>][,update=<ms>][,direction=<rise|fall|rise-and-fall>][,adaptive-voltage=<true|false>][,repeat=<true|false>][,<опциональные настройки>]
```

Смысл: плавный перебор частоты в диапазоне `start..end` за время `time` (в секундах) с равномерной скоростью.

Направления:
- `rise` — от `start` к `end`, затем (если `repeat=true`) возврат к `start` и новый цикл
- `fall` — от `end` к `start`, затем (если `repeat=true`) возврат к `end` и новый цикл
- `rise-and-fall` — вперёд‑назад непрерывно (start→end→start)

Примечание: `start` и `end` могут быть равны `0` (генератор поддерживает 0 Hz).

Параметры по умолчанию:
- `start=1`, `end=1000000`, `time=1`, `update=50`, `direction=rise-and-fall`, `adaptive-voltage=false`, `repeat=true`

`adaptive-voltage=true` — вместе с частотой автоматически подбирается **amplitude** по формуле вида `clamp(C * f^k, 5..20)`.

Пример (вперёд‑назад, 1→10000 Hz за 2 сек, с авто‑напряжением):
```csv
mod,start=1,end=10000,time=2,direction=rise-and-fall,adaptive-voltage=true,repeat=true,{"channel":"1+2","waveform":"sine"}
```

Пример (один проход вверх 100→1000 Hz за 5 сек):

> Если `mod` запущен в режиме **двух каналов** ("1+2"), некоторые устройства могут давать **прерывистый/нестабильный** сигнал при высокой частоте обновления. Рекомендуется использовать один канал (`{"channel":"1"}`) или включить синхронизацию каналов в настройках генератора.

```csv
mod,start=100,end=1000,time=5,direction=rise,repeat=false,{"channel":1}
```


### 5) Циклы частот

#### Вариант A (рекомендуется): `cycle`
```
cycle,[Hz1,Hz2,...],on=<сек>,off=<сек>[,pause_hz=<Hz>][,adaptive-voltage=<true|false>][,<опциональные настройки>]
```



**Диапазоны внутри списка:** можно добавлять объекты диапазонов, не разворачивая их в огромный массив в памяти:
```csv
cycle,[30000,44000,{"start":55000,"end":200000,"step":0.1},1000000],on=1,off=1
```
- `step` по умолчанию `1` (Гц)  
- диапазон **включительный** (включает `end`, если он попадает в шаг)  
- допускается “квазии‑JSON” с некавычковыми ключами (например `step: 0.1`), но лучше писать строгий JSON.


**Пример с диапазоном + авто‑напряжением и без паузы (`off=0`):**
```csv
cycle,[30000,44000,{"start":55000,"end":200000,"step":0.1},1000000],on=0.5,off=0,adaptive-voltage=true,{"channel":"1","waveform":"sine"}
```
В этом примере:
- частоты из диапазона перебираются лениво (в памяти не создаётся огромный список)
- `adaptive-voltage=true` автоматически подбирает **amplitude** по частоте
- `off=0` означает, что **между частотами не вставляется** `pause_hz` (частота переключается сразу на следующую)

Смысл: для каждой частоты из списка
1) поставить частоту, подождать `on`  
2) если `off > 0` — поставить `pause_hz` (по умолчанию **0 Hz**) и подождать `off`  
3) перейти к следующей частоте

Параметры:
- `on` — сколько держать каждую частоту (сек)
- `off` — пауза между частотами (сек). Если `off=0`, паузы нет и `pause_hz` не используется.
- `pause_hz` — частота на время `off` (по умолчанию `0`).
- `adaptive-voltage=true` — автоматически подбирается **amplitude** по частоте (как в `mod`).

При `adaptive-voltage=true` параметр `"amplitude"` из настроек игнорируется (напряжение подбирается автоматически).

Пример:
```csv
cycle,[1000,2000,3000],on=5,off=10,{"channel":"1+2","waveform":"sine","amplitude":1.0}
```

Также поддерживается позиционный вид:
```csv
cycle,[1000,2000,3000],5,10,{"channel":"1+2"}
```

#### Вариант B (совместимость): “старый” цикл через `freq + wait + freq,0 + wait`
```csv
freq,[1000,2000,3000],{"channel":"1+2"}
wait,5
freq,0
wait,10
```

---

## Настройки (JSON) и каналы

Третий параметр у `freq`/`cycle` — объект настроек. **Рекомендуется строгий JSON** (двойные кавычки, без лишних запятых):
```json
{"waveform":"sine","amplitude":1.0,"offset":0.8,"dutycycle":30}
```

Для удобства допускается и сокращённый “квазии‑JSON” (лучше всё же писать строгий):
```
{channel:"1+2",waveform:sine,amplitude:1.0}
```

Выбор канала:
- `"channel":"1+2"` (или `"both"`) — оба канала
- `"channel":1` — только канал 1
- `"channel":2` — только канал 2

Можно задавать отдельные параметры для каналов:
```json
{"ch1":{"frequency":1000,"amplitude":1.0},"ch2":{"frequency":1500,"amplitude":1.0,"offset":0.2}}
```

Включение/выключение выходов:
```json
{"channels":{"channel1":true,"channel2":false}}
```

---

## Важное про CSV и разделители

- Программа **авто‑определяет разделитель**: запятая `,`, точка‑с‑запятой `;` или таб `\t`.
- Внутри настроек используется JSON со своими запятыми — это нормально.
- Если вы редактируете файл в Excel/LibreOffice и он “ломает” строку, попробуйте:
  - сохранять как **CSV с разделителем `;`**, или
  - редактировать файл во встроенном редакторе программы.

---

## GUI: кнопки и полезные функции

- **Обновить** — перечитать список портов
- **Авто‑поиск** — найти устройство и выбрать “самый надёжный” порт (на Linux предпочитает `/dev/serial/by-id/...`)
- **Проверить CSV** — проверить файл на ошибки без запуска
- **Старт / Пауза / Стоп**
- **Следующая команда** — пропускает текущий `wait`
- **Фиксированный wait** — если включено, заменяет длительность всех `wait` во время выполнения
- Редактор поддерживает:
  - подсветку текущей строки,
  - **контекстное меню** (ПКМ: копировать/вставить/вырезать/выделить всё),
  - Ctrl+C / Ctrl+V работает даже при русской раскладке (Windows).

---

## CLI

```bash
python3 run_cli.py --list-ports
python3 run_cli.py --file commands.csv
python3 run_cli.py --port /dev/ttyUSB0 --file commands.csv
```

---

## Сборка

### Windows (.exe)
```powershell
powershell -ExecutionPolicy Bypass -File packaging\windows\build_windows.ps1
```
Результат: `dist\JDS6600Controller.exe`

### Linux (AppImage)
```bash
./packaging/linux/build_appimage.sh
```

---

## Ссылки
- Telegram разработчика: https://t.me/JcJet (@JcJet)
